<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="./jquery/demos/css/themes/default/jquery.mobile-1.4.5.min.css">
	<script src="./jquery/demos/js/jquery.js"></script>
	<script src="./jquery/demos/js/jquery.mobile-1.4.5.min.js"></script>

	<script src="./js/papaparse.min.js"></script>
	<script	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpShV7rlMoA4M7-3l1mi9XLYMsLJo8ZpA&v=3.exp&libraries=visualization"></script>

	<!-- Dropbox api -->
	<script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="j816zdgbhryyqbg"></script>

	<!-- Google api -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://www.google.com/jsapi?key=AIzaSyBpShV7rlMoA4M7-3l1mi9XLYMsLJo8ZpA"></script>
	<script src="https://apis.google.com/js/client.js?onload=initPicker"></script>

	<!-- color -->
	<script type="text/javascript" src="./js/Colour.js"></script>

	<style>

		#Header {
			margin: 30px;
		}

		#Footer p {
			color: whitesmoke; 
			background-color:#336600; 
			padding:7px; 
			margin-bottom:10px; 
			margin-top:0px; 
			font-size: 10px;
		}
		
		#MainMenu {
			margin-left:10px;
		}

		#map-canvas {
			padding:20%;
			margin-top: 25px;
		}

		#advancedPanel,#UrlMenu {
			width: 109%; 
			height: 370px;
			margin: 10px;
			align-content: center;	
		}

		.ui-icon-dropbox:after {
			background-image: url("./img/Dropbox.png");
			background-size: 18px 18px;
		}
		.ui-icon-gdrive:after {
			background-image: url("./img/Gdrive.png");
			background-size: 18px 18px;
		}
	  </style>

	  <script>
		var map;
		var zoom;
		var RR = [];
		var items =[];
		var lats = [];
		var lons = [];
		var max= 0;
		var min = 0;
		var opacity=50;
		var res=0.05;
		var cols = [];
		var selectedCol = 0;
		var thefile ;
		var download = false;
		var mapOptions = {
			zoom: 2,
			minZoom: 1,
			center: new google.maps.LatLng(0,0)
		};

	 	// http://stackoverflow.com/a/2901298/562440
		function numberWithCommas(x) {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function getColor(magnitude) {
			//var high = [5, 69, 54];  // color of smallest datum
			var high = [0, 100, 50];  // color of smallest datum
			//var low = [151, 83, 34];   // color of largest datum
			var low = [120, 100, 50];   // color of largest datum

			// delta represents where the value sits between the min and max
			var delta = magnitude / (max-min);
			
			var color = [];
			for (var i = 0; i < 3; i++) {
				// calculate an integer color based on the delta
				color[i] = (high[i] - low[i]) * delta + low[i];
			}
			return color;	
		}

		function handleFile(datafile) {
			thefile = document.getElementById("localfile").files[0];
			download = false;
			processFile()	;
		};

		function reReadFile() {
			opacity = $("#slider-opacity").val();
			res = $("#slider-res").val();
			RR=[];
			max= 0;
			min = 0;

			var parseres = Papa.parse(thefile, {
				download: download,
				header: true,
//				worker: true,
				dynamicTyping: true,
				withCredentials: true,
				complete: function(results) {
					RR = [];
					for(idx in results["data"]) {
						var row = results["data"][idx];

						// get min and max values of the scale 
						if ( row[cols[selectedCol]] > max ) { max = row[cols[selectedCol]] ; }
						if ( row[cols[selectedCol]] < min ) { min = row[cols[selectedCol]] ; }
						
						RR.push(row[cols[selectedCol]]);
					}
					updateItems();
					updateScaleControl();	
					console.log("All parsing done .. file reRead");	
				}
			});
		};

		function processFile()	{
			opacity = $("#slider-opacity").val();
			res = $("#slider-res").val();
			items=[];
			RR=[];
			lats=[];
			lons=[];
			cols=[];
			max= 0;
			min = 0;
			selectedCol = 0;
			
			delete(map);
			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			map.data.loadGeoJson('./cuba.json');

			return;
			map.addListener('zoom_changed', function() {
				zoom = map.zoom;
				console.log(zoom);
			});	

			var parseres = Papa.parse(thefile, {
				download: download,
				header: true,
//				worker: true,
				dynamicTyping: true,
				withCredentials: true,
				complete: function(results) {
					RR = [];
					var minlat=90;
					var maxlat=-90;
					var minlon=180;
					var maxlon=-180;

					// Get the columns name
					//var options_str="";	
					var options_str='<select class="ui-block-b" style="width:100%" name="columns" id="columns">'
					var valind = 1;	
					for (cn in  results["data"][0]) {
						if ( (cn !== "lat" && cn !== "lon") ){
							cols.push(cn);
							//Create and append the options
							if ( valind == 1) {
								options_str += '<option selected="selected" value="' + valind + '">' + cn + '</option>';
							} else {
								options_str += '<option value="' + valind + '">' + cn + '</option>';
							}
							valind = valind + 1;
						}
					}
					options_str += "</select>"
					document.getElementById("columnsDiv").innerHTML = options_str;

					$("#columns").change(function() {
						selectedCol = $(this).val() ;
					});

					for(idx in results["data"]) {
						var row = results["data"][idx];

						// get min and max values of the scale 
						if ( row[cols[selectedCol]] > max ) { max = row[cols[selectedCol]] ; }
						if ( row[cols[selectedCol]] < min ) { min = row[cols[selectedCol]] ; }
						// get min and max values of latitude
						if ( row["lat"] > maxlat ) { maxlat = row["lat"] ; }
						if ( row["lat"] < minlat ) { minlat = row["lat"] ; }
						// get min and max values of long
						if ( row["lon"] > maxlon ) { maxlon = row["lon"] ; }
						if ( row["lon"] < minlon ) { minlon = row["lon"] ; }
					}
					var GLOBE_WIDTH = 256; // a constant in Google's map projection
					var west = minlon;
					var east = maxlon;
					var angle = east - west;
					if (angle < 0) {
 						 angle += 360;
					}
					zoom = Math.round(Math.log(256 * 360 / angle / GLOBE_WIDTH) / Math.LN2);
					var center = new google.maps.LatLng( (minlat+maxlat)/2, (minlon+maxlon)/2 );
					map.panTo(center);
					map.setZoom(zoom);

					// todo cambiar la resolucion en funcion de valor de zoom 
					for(idx in results["data"]) {
						var row = results["data"][idx];
						var tile = res/2;
						if (row[cols[selectedCol]] != 0) {
						var rectangle = new google.maps.Rectangle({
															//strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															strokeOpacity: opacity/100,
															strokeWeight: 2,
															//fillColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															fillOpacity: opacity/100,
															map: map,
															bounds: {
																north:  row["lat"] + tile,
																south:  row["lat"] - tile,
																east:   row["lon"] + tile,
																west:   row["lon"] - tile,
															}
								});
						items.push(rectangle);
						lats.push(row["lat"]);
						lons.push(row["lon"]);
						RR.push(row[cols[selectedCol]]);
						}
					}

					updateItems();
					updateScaleControl();

					console.log("All parsing done");	
				}
			});
		};
		
		function updateScaleControl() {
			$("#scalemin").val(min);
			$("#scalemax").val(max);
		};

		function clearMap(){
			hideItems();
			items=[];
			RR=[];
			lats=[];
			lons=[];
		};

		function hideItems() {
			for (var i = 0; i < items.length; i++) {
        		items[i].setMap(null);
        	}	
		};

		function setMaxScale (value) {
			max = value;	
			updateItems();	
		}; 

		function setMinScale (value) {
			min = value;
			updateItems();
		}; 
		
		function updateItems() {	
			opacity = $("#slider-opacity").val();
			var oldTile = res/2;	
			res = $("#slider-res").val();
			var tile = res/2;			
			var north, south, east,west ; 
			
			for (var i = 0; i < items.length; i++) {
				var color = getColor(RR[i]);
				north = lats[i] + tile;
				south = lats[i] - tile;
				east  = lons[i] + tile,
				west  = lons[i] - tile,

        		items[i].setOptions({ 
								strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
								strokeOpacity: opacity/100,
								strokeWeight: 2,
								fillColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
								fillOpacity: opacity/100,
								bounds: {
										north: north,
										south: south,
										east:  east,
										west:  west,
									}
					}) ;

					google.maps.event.clearListeners(map, 'bounds_changed');

					google.maps.event.addListener(items[i],"mouseout",function(){	
						document.getElementById("log").innerHTML="scale";
					});		
					google.maps.event.addListener(items[i],"mouseover",function(){
						var coloratpoint = this.get('fillColor');
						var onItem = items.indexOf(this);
						if ( onItem == null ) {return;}
						var text =  "Value at <i>Lat</i>: " + "<b>" + lats[onItem] + "</b> , <i>Lon</i>: " +  "<b>" + lons[onItem] + "</b> = " + "<b>" + RR[onItem] + "</b>";
						document.getElementById("log").innerHTML=text;
					}); 
					google.maps.event.addListener(items[i],"click",function(){
						var onItem = items.indexOf(this);
						if ( onItem == null ) {return;}
						var place = new google.maps.LatLng( lats[onItem], lons[onItem]);
						var infowindow = new google.maps.InfoWindow(); 
						infowindow.setContent("Value: " + RR[onItem] + "<br/>Lat: "+ lats[onItem] + "<br/>Lon: " + lons[onItem]);
						infowindow.setPosition(place);
						infowindow.open(map);
					}); 
        	}
		};

		// When the page is loaded
		$(document).ready(function(){
			$("#localfile").change(handleFile);	

			$("#csv-file").click( function(){
					$("#localfile").click();
				});
				
			$("#options").click(function(){
					if ( $('#advancedPanel').is(":visible") ){ 
						$('#advancedPanel').hide();
					} else {
							$('#advancedPanel').show();
					}
				});

			$("#UrlGDrive").click( function(){
					initPicker();
				});

			$("#UrlDropbox").click( function(){
					noteAttachdb();
				});

			$("#clear").click(function() {
					clearMap()
				});

			$("#selectedMenu").change( function(){
					var selected = $(this).val();	
					if (selected == "Choose" ) {return;}
					thefile = "https://jonarbo.github.io/koeppen/Data/" + selected;
					download = true;
					processFile()	
				});
						
			$("#update").click(function() {
					res = $("#slider-res").val();
					opacity=$("#slider-opacity").val();
					setMaxScale( $("#scalemax").val() );
					setMinScale( $("#scalemin").val() );
				
					if ( selectedCol != $("#columns").val() - 1 ){
						selectedCol = $("#columns").val() - 1;
						reReadFile();
					} 
					updateItems();	 	
				});

			$("#advancedPanel").hide();
			$("#UrlMenu").hide();
			google.maps.event.addDomListener(window, 'load', initialize);
		});

		function initialize() {
		  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		}
		// Code for dropbox
		function noteAttachdb() {
			var options = {
			// Required. Called when a user selects an item in the Chooser.
			success: function(files) {
			$.each(files, function(index, fileId) {
			var filedb = "&lt;div class='attach'&gt;&lt;a target='_blank' href='" + fileId.link + "'&gt;" + fileId.name + "&lt;/a&gt;&lt;/div&gt;"
			$('#attachments').append(db);
			});
			},
			cancel: function() {
			},
			linkType: "preview", // or "direct"
			multiselect: true, // or true
			};
			Dropbox.choose(options);
		}

		// Code for GDrive
		function initPicker() {
			var picker = new FilePicker({
			apiKey: 'Your Api Key Here',
			clientId: 'Your Client Id here',
			buttonEl: document.getElementById('googlepicker'),
			onSelect: function(fileg) {
			alert('Selected ' + fileg.title);
			}
			});
			}
			(function() {
			var FilePicker = window.FilePicker = function(options) {
			this.apiKey = options.apiKey;
			this.clientId = options.clientId;
			this.buttonEl = options.buttonEl;
			this.onSelect = options.onSelect;
			this.buttonEl.addEventListener('click', this.open.bind(this));
			this.buttonEl.disabled = true;
			gapi.client.setApiKey(this.apiKey);
			gapi.client.load('drive', 'v2', this._driveApiLoaded.bind(this));
			google.load('picker', '1', {
			callback: this._pickerApiLoaded.bind(this)
			});
			}
			FilePicker.prototype = {
			open: function() {
			var token = gapi.auth.getToken();
			if (token) {
			this._showPicker();
			} else {
			this._doAuth(false, function() {
			this._showPicker();
			}.bind(this));
			}
			},
			_showPicker: function() {
			var accessToken = gapi.auth.getToken().access_token;
			this.picker = new google.picker.PickerBuilder().
			addView(google.picker.ViewId.DOCUMENTS).
			setAppId(this.clientId).
			setOAuthToken(accessToken).
			setCallback(this._pickerCallback.bind(this)).
			build().
			setVisible(true);
			},
			_pickerCallback: function(data) {
			if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
			var file = data[google.picker.Response.DOCUMENTS][0],
			id = file[google.picker.Document.ID],
			request = gapi.client.drive.files.get({
			fileId: id
			});
			request.execute(this._fileGetCallback.bind(this));
			}
			},
			_fileGetCallback: function(file) {
			if (this.onSelect) {
			this.onSelect(file);
			}
			},
			_pickerApiLoaded: function() {
			this.buttonEl.disabled = false;
			},
			_driveApiLoaded: function() {
			this._doAuth(true);
			},
			_doAuth: function(immediate, callback) {
			gapi.auth.authorize({
			client_id: this.clientId + '.apps.googleusercontent.com',
			scope: 'https://www.googleapis.com/auth/drive.readonly',
			immediate: immediate
			}, callback);
			}
			};
			}());

	  </script>
	</head>
<body>
		<!-- Header -->
		<div id="Header">
			<img src='./img/CCBLogo-transparent.png' alt="Consortium for Capacity Building">
			<h1 >Modified KOEPPEN for ENOS</h1>
		</div>

		<!-- Main -->
		<input type="file" id="localfile" style="display:none">
		<div id="MainMenu" data-role="controlgroup" data-type="horizontal">
				    <button id="csv-file" data-icon="action">Load File</button>
				    <button id="UrlGDrive"  class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-gdrive">GDrive</button>
					<button id="UrlDropbox" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-dropbox">Dropbox</button>	
					<!-- <button id="clear"   data-icon="recycle">Clear</button> -->
			    	<select  data-icon="bullets" name="select-native" id="selectedMenu">
					        <option value="Choose" >Our Data</option>
					        <optgroup label="South America"  >
					            <option value="guatemala.csv">Guatemala</option>
					            <option value="cuba.csv">Cuba</option>
					        </optgroup>
							 <optgroup label="Africa"  >
						            <option value="kenya.csv">Kenya</option>
					        </optgroup>
					        </optgroup>
							 <optgroup label="Asia"  >
						            <option value="indonesia.csv">Indonesia</option>
					        </optgroup>
					    </select>
			 	<button id="options" data-icon="gear">Options</button>
		</div>
		

		<!-- Menu for Advanced Options -->
		<div id="advancedPanel">

						<!-- RESOLUTION -->
						<div class="ui-block-b" style="width:90%">
							<div class="ui-bar ui-bar-a" style="height:60px">
								Resolution (deg)
								<input type="range" name="slider-2" id="slider-res" data-highlight="true" min="0.01" max="0.5" step="0.01" value="0.05">
							</div>
						</div>

						<!-- OPACITY -->
    					<div class="ui-block-a" style="width:90%">
							<div class="ui-bar ui-bar-a" style="height:60px">
								Opacity:
								<input type="range" name="slider-2" id="slider-opacity" data-highlight="true" min="0" max="100" value="50">
							</div>
						</div>
						
						<!-- SCALE min -->
						<div class="ui-block-a" style="width:10%">
							<div class="ui-bar ui-bar-a" style="height:50px;">
								<input type="number" data-clear-btn="false" name="scalemax" pattern="[0-9][0-9][0-9]" id="scalemin" value="0" size="4">
							</div>
						</div>
						<!-- SCALE -->
			    		<div class="ui-block-b" style="width:70%;">
							<div class="ui-bar ui-bar-a" style="height:50px ; align-content: center">
									<div  id="log" style="text-align: center; font-size: 12px">scale</div>
									<div style="height:20px; text-align: center; border: none; outline: none;cursor: pointer;background: linear-gradient(to right, #00ff00 0%, #ff0000 100%)"></div>
							</div>
						</div>
						<!-- SCALE max -->
						<div class="ui-block-c" style="width:10%; height: 30px;">
							<div class="ui-bar ui-bar-a" style="height:50px">
								<input type="number" data-clear-btn="false" name="scalemax" pattern="[0-9][0-9][0-9]" id="scalemax" value="0">
	    					</div>
						</div>
					
						<!-- COLUMNS -->
						<div class="ui-block-b" style="width:90%">
							<div id="select-cols" class="ui-bar ui-bar-a" style="height:60px">
								Showing:
										<div name="columnsDiv" id="columnsDiv" class="ui-bar ui-bar-a">
										</div>
									<!-- <select id="columns"></select> -->
							</div>
						</div>

						<!-- UPDATE -->
						<div class="ui-block-b" style="width:90%">
							<div class="ui-bar ui-bar-a" style="height:60px">
								<button id="update"  style="width: 15%;"  data-icon="refresh">Update</button>
							</div>
						</div>
					
		</div>
		
		<!-- there goes the map -->
		<div id="map-canvas"></div>

		<div id="Footer">
			<center><p>Copyright © 2018 The Consortium for Capacity Building - INSTAAR/University of Colorado in Boulder</p></center>
		</div>	
	
</body>

</html>
