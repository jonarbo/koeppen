<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="./jquery/demos/css/themes/default/jquery.mobile-1.4.5.min.css">
	<script src="./jquery/demos/js/jquery.js"></script>
	<script src="./jquery/demos/js/jquery.mobile-1.4.5.min.js"></script>

	<script src="./js/papaparse.min.js"></script>
	<script	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpShV7rlMoA4M7-3l1mi9XLYMsLJo8ZpA&v=3.exp&libraries=visualization"></script>

	<!-- Dropbox api -->
	<script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="j816zdgbhryyqbg"></script>

	<!-- Google api -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://www.google.com/jsapi?key=AIzaSyBpShV7rlMoA4M7-3l1mi9XLYMsLJo8ZpA"></script>
	<script src="https://apis.google.com/js/client.js?onload=initPicker"></script>

	<style>
		#Header {
			margin: 30px;
		}

		#Footer p {
			color: whitesmoke; 
			background-color:#336600; 
			padding:7px; 
			margin-bottom:10px; 
			margin-top:0px; 
			font-size: 10px;
		}
		
		#MainMenu {
			margin-left:10px;
		}

		#map-canvas {
			padding:20%;
			margin: 10px;
		}

		#advancedPanel,#UrlMenu {
			width: 90%; 
			margin: 10px;
		}

		.ui-icon-dropbox:after {
			background-image: url("./img/Dropbox.png");
			background-size: 18px 18px;
		}
		.ui-icon-gdrive:after {
			background-image: url("./img/Gdrive.png");
			background-size: 18px 18px;
		}
	  </style>

	  <script>
		var map;
		var csv = [];
		var items =[];
		var max= 0;
		var min=0;
		var opacity=50;
		var res=0.05;

	 	// http://stackoverflow.com/a/2901298/562440
		function numberWithCommas(x) {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function getColor(magnitude) {
			var high = [5, 69, 54];  // color of smallest datum
			var low = [151, 83, 34];   // color of largest datum

			// delta represents where the value sits between the min and max
			var delta = magnitude / 1;
			//var delta = magnitude / 3;

			var color = [];
			for (var i = 0; i < 3; i++) {
				// calculate an integer color based on the delta
				color[i] = (high[i] - low[i]) * delta + low[i];
			}
			//var dcolor = 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ;
			return color;	
		}

		function handleFile(datafile) {
			var file = document.getElementById("localfile").files[0];
			var download='false';
			processFile(file,download)	;
		};

		function processFile(file,download)	{
			opacity = $("#slider-opacity").val();
			res = $("#slider-res").val();
			Papa.parse(file, {
				download: download,
				header: true,
//				worker: true,
				dynamicTyping: true,
				withCredentials: true,
				complete: function(results) {
					csv = [];
					var minlat=0;
					var maxlat=0;
					var minlon=0;
					var maxlon=0;
					for(idx in results["data"]) {
						var row = results["data"][idx];
						// get min and max values of the scale 
						if ( row["RR"] > max ) { max = row["RR"] ; }
						if ( row["RR"] < min ) { min = row["RR"] ; }
						// get min and max values of latitude
						if ( row["lat"] > maxlat ) { maxlat = row["lat"] ; }
						if ( row["lat"] < minlat ) { minlat = row["lat"] ; }
						// get min and max values of long
						if ( row["lon"] > maxlon ) { maxlon = row["lon"] ; }
						if ( row["lon"] < minlon ) { minlon = row["lon"] ; }
						
/*				
						csv.push({
								location: new google.maps.LatLng(row["lat"], row["lon"]),
								weight: row["RR"]
							});
*/			
						var color = getColor(row["RR"])
/* 
						var marker = new google.maps.Marker({
																map: map,
													            position: new google.maps.LatLng( row["lat"],row["lon"] ),
																icon: {
																		path: google.maps.SymbolPath.CIRCLE,
																		scale: 1,
																		strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
																		strokeWeight: 1,
																		fillColor:  'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
																		fillOpacity: 0.5,
    																},
		  													});
*/							

						var tile = res/2;
						var rectangle = new google.maps.Rectangle({
															strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															strokeOpacity: 0.8,
															strokeWeight: 2,
															fillColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															fillOpacity: opacity/100,
															map: map,
															bounds: {
																north:  row["lat"] + tile,
																south:  row["lat"] - tile,
																east:   row["lon"] + tile,
																west:   row["lon"] - tile,
															}
								});
/*
						var circle = new google.maps.Circle({
															map: map,
															center: new google.maps.LatLng( row["lat"],row["lon"] ),
															radius: 4000,
															strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															strokeWeight: 1,
															fillColor:  'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															fillOpacity: 0.8
						});
*/						
						items.push(rectangle)
					}
					updateScaleControl();
					var center = new google.maps.LatLng( maxlat, minlon);
					map.panTo(center);
					var GLOBE_WIDTH = 256; // a constant in Google's map projection
					var west = minlon;
					var east = maxlon;
					var angle = east - west;
					if (angle < 0) {
 						 angle += 360;
					}
					var zoom = Math.round(Math.log(2000 * 360 / angle / GLOBE_WIDTH) / Math.LN2);
					map.setZoom(zoom);	
					console.log("All parsing done");	
				}
			});
		}
		
		function updateScaleControl() {
			$("#scalemin").val(min);
			$("#scalemax").val(max);
		};

		function clearMap(){
			hideItems();
			items=[];
		};

		function hideItems() {
			for (var i = 0; i < items.length; i++) {
        		items[i].setMap(null);
        	}	
		}

		// When the page is loaded
		$(document).ready(function(){

			$("#localfile").change(handleFile);	
			$("#csv-file").click( function(){
					$("#localfile").click();
			});
			
			$("#options").click(function(){
				if ( $('#advancedPanel').is(":visible") ){ 
				    $('#advancedPanel').hide();
				} else {
   	 				$('#advancedPanel').show();
				}
			});

			$("#UrlGDrive").click( function(){
				initPicker();
			});

			$("#UrlDropbox").click( function(){
				noteAttachdb();
			});

			$("#clear").click(function() {
				clearMap()
			});

			$("#selectmenu").change( function(){
				var selected = $(this).val();
				var file = "https://jonarbo.github.io/koeppen/Data/" + selected;
				processFile(file,true)	;
			});

			$("#advancedPanel").hide();
			$("#UrlMenu").hide();
			google.maps.event.addDomListener(window, 'load', initialize);
		});

		function initialize() {
		  var mapOptions = {
			zoom: 2,
			minZoom: 1,
			center: new google.maps.LatLng(0,0)
			//center: new google.maps.LatLng(15.7,-90)
		  };
		  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		}
		// Code for dropbox
		function noteAttachdb() {
			var options = {
			// Required. Called when a user selects an item in the Chooser.
			success: function(files) {
			$.each(files, function(index, file) {
			var file = "&lt;div class='attach'&gt;&lt;a target='_blank' href='" + file.link + "'&gt;" + file.name + "&lt;/a&gt;&lt;/div&gt;"
			$('#attachments').append(file);
			});
			},
			cancel: function() {
			},
			linkType: "preview", // or "direct"
			multiselect: true, // or true
			};
			Dropbox.choose(options);
		}

		// Code for GDrive
		function initPicker() {
			var picker = new FilePicker({
			apiKey: 'Your Api Key Here',
			clientId: 'Your Client Id here',
			buttonEl: document.getElementById('googlepicker'),
			onSelect: function(file) {
			console.log(file);
			alert('Selected ' + file.title);
			}
			});
			}
			(function() {
			var FilePicker = window.FilePicker = function(options) {
			this.apiKey = options.apiKey;
			this.clientId = options.clientId;
			this.buttonEl = options.buttonEl;
			this.onSelect = options.onSelect;
			this.buttonEl.addEventListener('click', this.open.bind(this));
			this.buttonEl.disabled = true;
			gapi.client.setApiKey(this.apiKey);
			gapi.client.load('drive', 'v2', this._driveApiLoaded.bind(this));
			google.load('picker', '1', {
			callback: this._pickerApiLoaded.bind(this)
			});
			}
			FilePicker.prototype = {
			open: function() {
			var token = gapi.auth.getToken();
			if (token) {
			this._showPicker();
			} else {
			this._doAuth(false, function() {
			this._showPicker();
			}.bind(this));
			}
			},
			_showPicker: function() {
			var accessToken = gapi.auth.getToken().access_token;
			this.picker = new google.picker.PickerBuilder().
			addView(google.picker.ViewId.DOCUMENTS).
			setAppId(this.clientId).
			setOAuthToken(accessToken).
			setCallback(this._pickerCallback.bind(this)).
			build().
			setVisible(true);
			},
			_pickerCallback: function(data) {
			if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
			var file = data[google.picker.Response.DOCUMENTS][0],
			id = file[google.picker.Document.ID],
			request = gapi.client.drive.files.get({
			fileId: id
			});
			request.execute(this._fileGetCallback.bind(this));
			}
			},
			_fileGetCallback: function(file) {
			if (this.onSelect) {
			this.onSelect(file);
			}
			},
			_pickerApiLoaded: function() {
			this.buttonEl.disabled = false;
			},
			_driveApiLoaded: function() {
			this._doAuth(true);
			},
			_doAuth: function(immediate, callback) {
			gapi.auth.authorize({
			client_id: this.clientId + '.apps.googleusercontent.com',
			scope: 'https://www.googleapis.com/auth/drive.readonly',
			immediate: immediate
			}, callback);
			}
			};
			}());

	  </script>
	</head>
<body>
		<!-- Header -->
		<div id="Header">
			<img src='./img/CCBLogo-transparent.png' alt="Consortium for Capacity Building">
			<h1 >Modified KOEPPEN for ENOS</h1>
		</div>

		<!-- Main -->
		<input type="file" id="localfile" style="display:none">
		<div id="MainMenu" data-role="controlgroup" data-type="horizontal">
				    <button id="csv-file" data-icon="action">Load File</button>
				    <button id="UrlGDrive"  class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-gdrive">GDrive</button>
					<button id="UrlDropbox" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-dropbox">Dropbox</button>	
					<!-- <button id="clear"   data-icon="recycle">Clear</button> -->
			    	<select  data-icon="bullets" name="select-native" id="selectmenu">
					        <option>Our Data</option>
					        <optgroup label="South America"  >
					            <option value="guatemala.csv">Guatemala</option>
					        </optgroup>
					    </select>
			 	<button id="options" data-icon="gear">Options</button>
		</div>
		

		<!-- Menu for Advanced Options -->
		<div id="advancedPanel">
    					<div class="ui-block-a" style="width:45%">
							<div class="ui-bar ui-bar-a" style="height:60px">
								Opacity:
								<input type="range" name="slider-2" id="slider-opacity" data-highlight="true" min="0" max="100" value="50">
							</div>
						</div>
    					<div class="ui-block-b" style="width:45%">
							<div class="ui-bar ui-bar-a" style="height:60px">
								Resolution (deg)
								<input type="range" name="slider-2" id="slider-res" data-highlight="true" min="0.01" max="0.1" step="0.01" value="0.05">
							</div>
						</div>
					
						<div class="ui-block-a" style="width:10%">
							<div class="ui-bar ui-bar-a" style="height:50px">
								<input type="number" data-clear-btn="false" name="scalemax" pattern="[0-9][0-9][0-9]" id="scalemin" value="0" size="4">
							</div>
						</div>

			    		<div class="ui-block-b" style="width:70%;">
							<div class="ui-bar ui-bar-a" style="height:50px"><label style="text-align: center">scale</label>
								<div style="height:20px; text-align: center; border: none; outline: none;cursor: pointer;background: linear-gradient(to right, #00ff00 0%, #ff0000 100%)">|</div>
							</div>
						</div>

    					<div class="ui-block-c" style="width:10%">
							<div class="ui-bar ui-bar-a" style="height:50px">
								<input type="number" data-clear-btn="false" name="scalemax" pattern="[0-9][0-9][0-9]" id="scalemax" value="0">
	    					</div>
						</div>
		</div>
		
		<!-- there goes the map -->
		<div id="map-canvas"></div>

		<div id="Footer">
			<center><p>Copyright © 2018 The Consortium for Capacity Building - INSTAAR/University of Colorado in Boulder</p></center>
		</div>	
	
</body>

</html>
