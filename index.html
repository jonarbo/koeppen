<!DOCTYPE html>
<html>
<head>
		<link rel="stylesheet" href="../css/themes/default/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="../_assets/css/jqm-demos.css">
		<script src="../js/jquery.js"></script>
		<script src="../_assets/js/index.js"></script>
		<script src="../js/jquery.mobile-1.4.5.min.js"></script>
		
	<style>
    html, body {
      height: 100%;
      margin: 10px;
	  clear: both;
      padding: 10px;
			font-family: 'Raleway', sans-serif;
			z-index:1;
   		}
	#map-canvas {
	  height: 50%;
      margin: 10px;
	  clear: both;
      padding: 10px;
			font-family: 'Raleway', sans-serif;
			z-index:1;

	}

	#opacity-slider    .ui-slider-handle { cursor: pointer }
	#resolution-slider .ui-slider-handle { cursor: pointer }


	/* Style the tab */
	.tab {
		overflow: hidden;
		border: 1px solid #ccc;
		background-color: #f1f1f1;
	}

	/* Style the buttons inside the tab */
	.tab button {
		background-color: inherit;
		float: left;
		border: none;
		outline: none;
		cursor: pointer;
		padding: 10px 12px;
		transition: 0.3s;
		font-size: 15px;
	}

	/* Change background color of buttons on hover */
	.tab button:hover {
		background-color: #ddd;
	}

	/* Create an active/current tablink class */
	.tab button.active {
		background-color: #ccc;
	}

	/* Style the tab content */
	.tabcontent {
		display: none;
		padding: 6px 12px;
		border: 1px solid #ccc;
		border-top: none;
	}
  </style>
	
	<script src="./js/papaparse.min.js"></script>
	<script	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpShV7rlMoA4M7-3l1mi9XLYMsLJo8ZpA&v=3.exp&libraries=visualization"></script>

	<script>
		var map, heatmap;
		var csv = [];
		var items =[];

    	// http://stackoverflow.com/a/2901298/562440
		function numberWithCommas(x) {
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function getColor(magnitude) {
				var high = [5, 69, 54];  // color of smallest datum
				var low = [151, 83, 34];   // color of largest datum

				// delta represents where the value sits between the min and max
				var delta = magnitude / 1;
				//var delta = magnitude / 3;

				var color = [];
				for (var i = 0; i < 3; i++) {
				// calculate an integer color based on the delta
				color[i] = (high[i] - low[i]) * delta + low[i];
				}
				//var dcolor = 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ;

				return color;	
			}

		function handleFile(datafile) {
			//var file = datafile
			var file = datafile.target.files[0];
			var download='false';
			processFile(file,download)	
		};

		function processFile(file,download)	{
			Papa.parse(file, {
				download: download,
				header: true,
				worker: true,
				dynamicTyping: true,
				complete: function(results) {
					csv = [];
					for(idx in results["data"]) {
						var row = results["data"][idx];
						
/*					
						csv.push({
								location: new google.maps.LatLng(row["lat"], row["lon"]),
								weight: row["RR"]
							});
*/			
						var color = getColor(row["RR"])
/* 
						var marker = new google.maps.Marker({
																map: map,
													            position: new google.maps.LatLng( row["lat"],row["lon"] ),
																icon: {
																		path: google.maps.SymbolPath.CIRCLE,
																		scale: 1,
																		strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
																		strokeWeight: 1,
																		fillColor:  'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
																		fillOpacity: 0.5,
    																},
		  													});
*/							

						var rectangle = new google.maps.Rectangle({
															strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															strokeOpacity: 0.8,
															strokeWeight: 2,
															fillColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															fillOpacity: 0.5,
															map: map,
															bounds: {
																north:  row["lat"] + 0.025,
																south:  row["lat"] - 0.025,
																east:   row["lon"] + 0.025,
																west:   row["lon"] - 0.025,
															}
								});
/*
						var circle = new google.maps.Circle({
															map: map,
															center: new google.maps.LatLng( row["lat"],row["lon"] ),
															radius: 4000,
															strokeColor: 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															strokeWeight: 1,
															fillColor:  'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)' ,
															fillOpacity: 0.8
						});
*/						
						items.push(rectangle)
					}
					//loadHeatmap(csv);	
					console.log("All parsing done");	
				}
			});
		}

		/*
		function hideItems() {
			for (var i = 0; i < items.length; i++) {
        		items[i].setMap(null);
        	}	
		}

		function showItems() {
			for (var i = 0; i < items.length; i++) {
        		items[i].setMap(map);
        	}	
		}
	*/
		function clearMap() {
			hideItems();
			items=[];
		}

		function loadHeatmap(csv) {
			var pointArray = new google.maps.MVCArray(csv);
			if(heatmap) heatmap.setMap(null);
			
			heatmap = new google.maps.visualization.HeatmapLayer({
				data: pointArray,
				radius: 1,
				opacity: 0.5
			});
			
			heatmap.setMap(map);
		}
		
		function initialize() {
		  var mapOptions = {
			zoom: 2,
			minZoom: 1,
			center: new google.maps.LatLng(0,0)
			//center: new google.maps.LatLng(15.7,-90)
		  };

		  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

		  //var file = '/Users/jonarbo/Devel/koeppen/Data/guatemala-cleaned-short.csv'
		  //handleFile(file)	
		}
		
		$(document).ready(function(){
			$("#csv-file").change(handleFile);
			$("#go").click( function(){
				processFile($("#remotefile").text(),true);
			}); 

			$("#clear").click(function() {
				clearMap()
			});
			$(function() {
				$( "#resolution-slider" ).slider({
						orientation: "horizontal",
						range: "min",
						min: 0.01,
						max: 0.1,
						value: 0.05,
						slide: function(event, ui) {
							$("#resolution-label").html("resolution: " + ui.value + " degrees");
						}
				});
			});
			$(function() {
				$( "#opacity-slider" ).slider({
						orientation: "horizontal",
						range: "min",
						min: 0,
						max: 100,
						value: 50,
						slide: function(event, ui) {
							$("#opacity-label").html("opacity: " + ui.value/100);
							if (items.length != 0 ){
								for (var i = 0; i < items.length; i++) {
        							items[i].set('opacity', ui.value/100);
        						}	
							}
						}
				});
			});

			$("#localFile").click(function() {
				$("#controls").show();
				$("#controlsUrl").hide();
    		});
			$("#urlFile").click(function() {
				$("#controls").hide();
				$("#controlsUrl").show();
    		});
			$("#advanced").click(function(){
				$("#advancedHide").show();
				$("#advanced").hide();
				$("#advancedPanel").show();	
			});
			$("#advancedHide").click(function(){
				$("#advancedHide").hide();
				$("#advanced").show();
				$("#advancedPanel").hide();	
			});
			$("#controls").show();
			$("#controlsUrl").hide();
    		$("#advancedHide").hide();
    		$("#advancedPanel").hide();

			google.maps.event.addDomListener(window, 'load', initialize);
		});
	</script>
</head>
<body>
	<div id="Header">
		<img src='./img/CCBLogo.jpg' alt="Consortium for Capacity Building">
		<h1 margin="10px" >Modified KOEPPEN for ENOS</h1>
	</div>

	<div class="tab">
		<button id="localFile" class="tablinks" >Local File</button>
		<button id="urlFile" class="tablinks" >URL</button>
		<button id="clear">Clear</button>
		<button id="advanced">Show Advanced Config</button>
		<button id="advancedHide">Hide Advanced Config</button>
	</div>

	<div id="controls" class="tabcontent" style="padding:10px;"   >
		<input type="file" id="csv-file" name="files" style="margin-right:10px; height:25px" />
	</div>
	<div id="controlsUrl" class="tabcontent" style="padding:10px;" >
		<button id="go">Go</button>
		<input id="remotefile" type="text" onfocus="this.value=''" value="http://" size=75>
	</div>

	<div id="advancedPanel">
		<div id="opacity" style="float:left; margin-top: 15px; margin-bottom: 15px; width:20%;  border: 1px solid #ccc; padding: 10px">
			<div id="opacity-label" style="margin-bottom: 8px">opacity: 0.5</div> 
			<div id="opacity-slider"></div>		
		</div>
		
		<div id="resolution" style="float:left; margin-left: 25px;margin-top: 15px; margin-bottom: 15px; width:20%;border: 1px solid #ccc; padding:10px">
		</div>
	
		<div id="scale" style="float:left; margin-left: 25px;margin-top: 15px; margin-bottom: 15px; width:20%;border: 1px solid #ccc; padding:10px">

			<div style="text-align: center; border: none; outline: none;cursor: pointer;background: linear-gradient(to right, #00ff00 0%, #ff0000 100%)">0</div>	
		</div> 
	

				<div>
				<form>
                    <input type="range" name="slider-2" id="slider-2" data-highlight="true" min="0" max="100" value="50">
				</form>
                </div>

	</div>
	
	<!-- there goes the map -->
	<div id="map-canvas">
	</div>

	<div id="Footer">
			<center><p style="color: whitesmoke; background-color:#336600; padding:7px; margin-bottom:10px; margin-top:0px; font-size: 10px;">Copyright Â© 2018 The Consortium for Capacity Building - INSTAAR/University of Colorado in Boulder</p></center>
	</div>

</body>
</html>